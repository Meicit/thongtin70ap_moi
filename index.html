<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thông tin Ấp</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 font-sans">
  <div class="container mx-auto p-4 space-y-6">

    <!-- Chọn Ấp -->
    <section class="bg-white shadow rounded-2xl p-6">
      <h2 class="text-xl font-semibold mb-4">🏘️ Chọn Ấp</h2>
      <select id="apSelect" class="p-2 border rounded"></select>
    </section>

    <!-- Thông tin Ấp -->
    <section id="info" class="bg-white shadow rounded-2xl p-6">
      <h2 class="text-xl font-semibold mb-4">ℹ️ Thông tin Ấp</h2>
      <div id="apInfo"></div>
    </section>

    <!-- Bản đồ PDF -->
    <section id="map" class="bg-white shadow rounded-2xl p-6">
      <h2 class="text-xl font-semibold mb-4">📍 Bản đồ Ấp</h2>
      <div class="w-full h-[500px]">
        <iframe id="apMap"
          class="w-full h-full rounded-xl border"
          title="Bản đồ Ấp"></iframe>
      </div>
    </section>

    <!-- Nhân sự từ Excel -->
    <section id="people" class="bg-white shadow rounded-2xl p-6">
      <h2 class="text-xl font-semibold mb-4">👥 Nhân sự Ấp</h2>
      <ul id="apPeople" class="space-y-2"></ul>
    </section>
  </div>

  <script>
  let apData = {}; // lưu dữ liệu từ Excel

  // Hàm đọc file Excel tổng hợp thông tin Ấp
  async function loadThongTinAp() {
    const response = await fetch("data/thongtin_ap.xlsx");
    const arrayBuffer = await response.arrayBuffer();
    const data = new Uint8Array(arrayBuffer);
    const workbook = XLSX.read(data, { type: "array" });
    const sheetName = workbook.SheetNames[0];
    const sheet = workbook.Sheets[sheetName];
    const json = XLSX.utils.sheet_to_json(sheet);

    // Lưu dữ liệu theo key
    json.forEach(row => {
      apData[row.ApKey] = row;
    });

    // Tạo danh sách chọn Ấp
    const apSelect = document.getElementById("apSelect");
    apSelect.innerHTML = Object.values(apData)
      .map(ap => `<option value="${ap.ApKey}">${ap.TenAp}</option>`)
      .join("");

    // Load mặc định Ấp đầu tiên
    loadAp(Object.keys(apData)[0]);
  }

  // Hàm đọc file Excel nhân sự cho từng Ấp
  async function loadExcelNhanSu(filePath) {
    try {
      const response = await fetch(filePath);
      const arrayBuffer = await response.arrayBuffer();
      const data = new Uint8Array(arrayBuffer);
      const workbook = XLSX.read(data, { type: "array" });
      const sheetName = workbook.SheetNames[0];
      const sheet = workbook.Sheets[sheetName];
      const json = XLSX.utils.sheet_to_json(sheet);

      const apPeople = document.getElementById("apPeople");
      apPeople.innerHTML = json
        .map(row => `<li>👤 <strong>${row.HọTên}</strong> – ${row.ChứcDanh} – 📱 ${row.SĐT}</li>`)
        .join("");
    } catch (error) {
      console.error("Lỗi khi tải Excel nhân sự:", error);
    }
  }

  // Hàm load dữ liệu Ấp theo key
  function loadAp(apKey) {
    const ap = apData[apKey];
    if (!ap) return;

    // cập nhật thông tin Ấp
    document.getElementById("apInfo").innerHTML = `
      <p><strong>Tên Ấp:</strong> ${ap.TenAp}</p>
      <p><strong>Diện tích:</strong> ${ap.DienTich}</p>
      <p><strong>Dân số:</strong> ${ap.DanSo}</p>
      <p><strong>Địa chỉ:</strong> ${ap.DiaChi}</p>
    `;

    // cập nhật bản đồ PDF
    document.getElementById("apMap").src = `${ap.MapFile}#toolbar=0&navpanes=0&scrollbar=0`;

    // cập nhật nhân sự
    loadExcelNhanSu(ap.ExcelNhanSu);
  }

  // Sự kiện chọn Ấp
  document.getElementById("apSelect").addEventListener("change", (e) => {
    loadAp(e.target.value);
  });

  // Khởi động
  document.addEventListener("DOMContentLoaded", loadThongTinAp);
  </script>
</body>
</html>
